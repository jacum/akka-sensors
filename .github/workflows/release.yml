name: Release to Sonatype

on:
  workflow_dispatch:
  push:
    branches:
      - master
      - main

permissions:
  contents: write  # sbt-release will create tags and push commits

jobs:
  release:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    env:
      # Trigger Publish.settings ReleaseToSonatype branch
      USERNAME: ${{ github.actor }}
      SONATYPE_USER: ${{ secrets.SONATYPE_USER }}
      SONATYPE_PASSWORD: ${{ secrets.SONATYPE_PASSWORD }}
      # Passphrase for signing (sbt-pgp reads this)
      PGP_PASSPHRASE: ${{ secrets.GPG_PASS }}
      # gpg on headless runners

    steps:
      - name: Checkout
      # sbt-release needs tags and full history
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '21'
          cache: sbt

      - name: Setup sbt
        uses: sbt/setup-sbt@v1

      - name: Cache Ivy and Coursier
        uses: actions/cache@v4
        with:
          path: |
            ~/.ivy2/cache
            ~/.cache/coursier
            ~/.sbt
          key: ${{ runner.os }}-sbt-${{ hashFiles('**/build.sbt', '**/project/**.sbt', '**/project/**.scala') }}
          restore-keys: |
            ${{ runner.os }}-sbt-

      - name: Import GPG private key
        shell: bash
        run: |
          mkdir -p ~/.gnupg
          chmod 700 ~/.gnupg
          echo "pinentry-mode loopback" >> ~/.gnupg/gpg.conf
          echo "use-agent" >> ~/.gnupg/gpg.conf
          echo "allow-loopback-pinentry" >> ~/.gnupg/gpg-agent.conf
          printf "%s" "${GPG_SECRET}" | gpg --batch --import
          # reload agent to pick up allow-loopback-pinentry
          gpgconf --kill gpg-agent || true
        env:
          GPG_SECRET: ${{ secrets.GPG_SECRET }}

      - name: Show GPG keys (debug)
        if: always()
        run: |
          gpg --version
          gpg --list-keys || true
          gpg --list-secret-keys || true

      - name: Configure Git identity for release
        run: |
          git config user.email "ci@users.noreply.github.com"
          git config user.name "GitHub Actions Release Bot"

      - name: Run tests
        run: sbt "++2.13.16; test"

      - name: Release to Sonatype (bundle + close + release)
        run: sbt "release with-defaults"
